generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─────────────────────────────────────────────
// CATALOG
// ─────────────────────────────────────────────

model Collection {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("collections")
}

model Product {
  id              String           @id @default(cuid())
  name            String
  slug            String           @unique
  sku             String           @unique
  description     String?
  heritageStory   String?
  price           Float
  compareAtPrice  Float?
  collectionId    String?
  collection      Collection?      @relation(fields: [collectionId], references: [id])
  tags            String[]
  isPublished     Boolean          @default(false)
  isFeatured      Boolean          @default(false)
  trackInventory  Boolean          @default(true)
  continueOnOOS   Boolean          @default(false)
  images          ProductImage[]
  variants        ProductVariant[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@map("products")
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  altText   String?
  isMain    Boolean @default(false)
  order     Int     @default(0)

  @@map("product_images")
}

model ProductVariant {
  id            String      @id @default(cuid())
  productId     String
  product       Product     @relation(fields: [productId], references: [id], onDelete: Cascade)
  sizeEU        String
  color         String?
  colorHex      String?
  stockQty      Int         @default(0)
  priceModifier Float       @default(0)
  orderItems    OrderItem[]
  cartItems     CartItem[]

  @@unique([productId, sizeEU, color])
  @@map("product_variants")
}

// ─────────────────────────────────────────────
// CART & WISHLIST
// ─────────────────────────────────────────────

model Cart {
  id         String     @id @default(cuid())
  sessionId  String?    @unique
  customerId String?
  customer   Customer?  @relation(fields: [customerId], references: [id])
  items      CartItem[]
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        String         @id @default(cuid())
  cartId    String
  cart      Cart           @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product        @relation(fields: [productId], references: [id])
  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id])
  quantity  Int            @default(1)

  @@unique([cartId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  productId  String
  product    Product  @relation(fields: [productId], references: [id])
  addedAt    DateTime @default(now())

  @@unique([customerId, productId])
  @@map("wishlist_items")
}

// ─────────────────────────────────────────────
// CUSTOMERS
// ─────────────────────────────────────────────

model Customer {
  id        String         @id // = Supabase Auth user.id (UUID)
  email     String         @unique
  firstName String?
  lastName  String?
  phone     String?
  addresses Address[]
  orders    Order[]
  carts     Cart[]
  wishlist  WishlistItem[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@map("customers")
}

model Address {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id])
  firstName    String
  lastName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  country      String   @default("Nigeria")
  isDefault    Boolean  @default(false)

  @@map("addresses")
}

// ─────────────────────────────────────────────
// ORDERS
// ─────────────────────────────────────────────

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id])
  // Guest checkout
  guestEmail      String?
  guestFirstName  String?
  guestLastName   String?
  guestPhone      String?
  // Snapshot of shipping address (JSON so it's immutable)
  shippingAddress Json
  items           OrderItem[]
  subtotal        Float
  shippingFee     Float         @default(5000)
  discountAmount  Float         @default(0)
  discountCodeId  String?
  discountCode    DiscountCode? @relation(fields: [discountCodeId], references: [id])
  total           Float
  currency        String        @default("NGN")
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(UNPAID)
  paymentGateway  String?       // "paystack" | "stripe"
  paymentRef      String?
  notes           String?
  transactions    Transaction[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
  PARTIALLY_REFUNDED
}

model OrderItem {
  id          String         @id @default(cuid())
  orderId     String
  order       Order          @relation(fields: [orderId], references: [id])
  productId   String
  product     Product        @relation(fields: [productId], references: [id])
  variantId   String
  variant     ProductVariant @relation(fields: [variantId], references: [id])
  productName String
  size        String
  color       String?
  imageUrl    String?
  quantity    Int
  unitPrice   Float
  lineTotal   Float

  @@map("order_items")
}

// ─────────────────────────────────────────────
// PAYMENTS
// ─────────────────────────────────────────────

model Transaction {
  id        String   @id @default(cuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id])
  gateway   String   // "paystack" | "stripe"
  reference String   @unique
  amount    Float
  currency  String
  status    String   // "success" | "failed" | "pending"
  metadata  Json?
  createdAt DateTime @default(now())

  @@map("transactions")
}

// ─────────────────────────────────────────────
// PROMOTIONS
// ─────────────────────────────────────────────

model DiscountCode {
  id           String    @id @default(cuid())
  code         String    @unique
  type         String    // "percentage" | "fixed"
  value        Float
  minimumOrder Float?
  maxUses      Int?
  usedCount    Int       @default(0)
  expiresAt    DateTime?
  isActive     Boolean   @default(true)
  orders       Order[]
  createdAt    DateTime  @default(now())

  @@map("discount_codes")
}

// ─────────────────────────────────────────────
// ADMIN & CONTACT
// ─────────────────────────────────────────────

model AdminUser {
  id        String   @id
  email     String   @unique
  name      String
  role      String   @default("admin")
  createdAt DateTime @default(now())

  @@map("admin_users")
}

model ContactMessage {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("contact_messages")
}
